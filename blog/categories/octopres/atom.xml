<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Octopres | Blog 1]]></title>
  <link href="https://vincenttam.github.io/blog/categories/octopres/atom.xml" rel="self"/>
  <link href="https://vincenttam.github.io/"/>
  <updated>2016-02-22T16:46:40+08:00</updated>
  <id>https://vincenttam.github.io/</id>
  <author>
    <name><![CDATA[Vincent Tam]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    
      <title type="html"><![CDATA[Rake Deploy Fatal Error]]></title>
      <link href="https://vincenttam.github.io/blog/2016/02/22/rake-deploy-fatal-error/"/>
    
    <updated>2016-02-22T12:16:16+08:00</updated>
    <id>https://vincenttam.github.io/blog/2016/02/22/rake-deploy-fatal-error</id>
    
      <content type="html"><![CDATA[<h2 id="background">Background</h2>

<p>I had finished writing <a href="/blog/2016/02/22/git-for-windows-curl-gist-dot-vim-with-vundle-1/">my previous post</a>.  In <code>rake preview</code>, I
got the desired output.  Then, the next step is to commit the changes
and to deploy the generated contents to GitHub Pages.</p>

<h2 id="problem">Problem</h2>

<p>A large block of red text appeared after I ran <code>rake deploy</code>.  The
commit on the <code>master</code> branch was <em>unsuccessful</em>.</p>

<pre class="cli"><code>$ rake deploy
(in C:/github/vincenttam.github.io)
cp -r source/fancybox/.gitattributes public/fancybox/.gitattributes
cd _deploy
Already up-to-date.
cd -
rm -rf _deploy/404.html
...
rm -rf _deploy/stylesheets
cp -r public/. _deploy
cd _deploy
fatal: CRLF would be replaced by LF in fancybox/README.md.
On branch master
Your branch is up-to-date with 'origin/master'.
Changes not staged for commit:
        modified:   404.html
        modified:   about/index.html
        ...

Untracked files:
        blog/2016/02/21/
        blog/2016/02/22/
        downloads/code/miktex-update2/
        images/posts/MikTeXUpdate2/
        posts/31/

no changes added to commit
Everything up-to-date
cd -
## Set the codepage to 65001 for Windows machines
## Deploying branch to Github Pages
## Pulling any updates from Github Pages

## Copying public to _deploy

## Committing: Site updated at 2016-02-22 03:37:22 UTC

## Pushing generated _deploy website

## Github Pages deploy complete
</code></pre>

<p>Even though the system said that the deploy was “complete”, in fact,
it had <em>never</em> been carried out.</p>

<p><strong>How can I update my blog on GitHub Pages?</strong></p>

<!-- more -->

<h2 id="discussion">Discussion</h2>

<p>In the above error output, it took me a minute to find out <em>at which
stage</em> the deploy had failed: the line starting with “fatal”.
Therefore, I stripped off all <code>\r</code> from <code>source/fancybox/README.md</code>.
I tried deploying it again, and it <em>failed</em>—the <em>same</em> “fatal” error
appeared for <em>another file</em>.  I tried committing the change for
<code>source/fancybox/README.md</code>, but I <em>couldn’t</em> commit this.  I tried
googling “fatal crlf would be replaced by lf”, and clicked on
<a href="http://stackoverflow.com/q/20168639">the first search result</a>.  The answers in this Stack
Overflow question suggested that the option <code>core.autocrlf</code> should be
configured to <code>false</code>.  To be safe, I
<a href="https://github.com/VundleVim/Vundle.vim/wiki#win1">turned on <code>core.safecrlf</code></a>.<sup id="fnref:2"><a href="#fn:2" class="footnote">1</a></sup></p>

<p>When I <a href="/blog/2016/02/22/git-for-windows-curl-gist-dot-vim-with-vundle-1/">updated Git for Windows</a>, I chose “<strong>Checkout
Windows-style, commit Unix-style line endings</strong>” (the <em>first</em> radio
button), which the Git Setup dialog recommended.</p>

<picture class="fancybox" title="Git line conversion configuration">
  <source srcset="/images/posts/GitUpdate/autocrlf.png" media="(min-width: 505px)" />
  <img alt="Git line conversion configuration" width="300" src="https://vincenttam.github.io/images/posts/GitUpdate/autocrlf.png" />
</picture>
<p><small>Picture from <a href="http://i.stack.imgur.com/vPJCI.png">here</a>.</small></p>

<p>I love using bash utilities and (G)Vim.  In Git Bash, the former gives
LF line terminators, while the later gives CRLF.  Therefore, I decided
to <code>set fileformat=unix</code> in my VIMRC.<sup id="fnref:1"><a href="#fn:1" class="footnote">2</a></sup>  However, this <em>doesn’t</em>
unify the EOL of files in the local repository.</p>

<p>As I clone Git repositories, the line terminators are automatically
converted to CRLF.</p>

<h2 id="solution">Solution</h2>

<p><em>Completely</em> get rid of carriage returns <code>\r</code> in Git repositories!</p>

<p>To see how many files had CRLF line terminators, I tried using <code>grep</code>
in Git Bash, but <a href="http://stackoverflow.com/a/73886">this answer on Stack Overflow</a> <em>didn’t</em>
work.</p>

<pre class="cli"><code>$ find source -type f -exec grep -Iq . {} \; -and -exec dos2unix {} \;
dos2unix: converting file source/404.md to Unix format...
dos2unix: converting file source/about/index.markdown to Unix format...
dos2unix: converting file source/about/mybyobuconf.markdown to Unix format...
...
dos2unix: converting file source/_posts/2016-02-22-git-for-windows-curl-with-vun
dle-1.markdown~ to Unix format...
dos2unix: converting file source/_posts/2016-02-22-testing-octopress-and-ruby-2-
dot-0-on-windows-7-3.markdown to Unix format...
dos2unix: converting file source/_posts/2016-02-22-testing-octopress-and-ruby-2-
dot-0-on-windows-7-3.markdown~ to Unix format...
</code></pre>

<p>For the explanation of the above command, you may refer to
<a href="/blog/2015/08/22/used-more-bash-utilities/"><em>Used More Bash Utilities</em></a>.</p>

<p>After that, since <code>core.autocrlf</code> has been set to <code>false</code>, <code>git
checkout</code> no longer inserts <code>\r</code> into the files in the local
repository.  Therefore, even though <code>git status</code> reports unstaged
changes, running <code>git checkout -- source</code> <em>won’t</em> hurt the files.  I
can finally deploy the contents to GitHub Pages.<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>

<h2 id="lessons-learnt">Lessons learnt</h2>

<p><em>Never</em> run <code>rake generate</code> nor <code>rake preview</code> in <code>cmd.exe</code>!  Run this
in Git Bash, or other shells that <em>don’t</em> give you carriage returns.</p>

<p>When a new post is created with <code>rake new_post['...']</code> in either Git
Bash or Command Prompt, the created post has DOS line endings.
Therefore, we need to take extra care with this by using <code>dos2unix</code> in
Git Bash.</p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:2">

      <p>Refer to <a href="http://stackoverflow.com/a/1547108">this Stack Overflow question</a> for my reason
of enabling <code>core.safecrlf</code>. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:1">
      <p>Refer to line 100 of my <code>_vimrc</code> at version <a href="https://goo.gl/iETw5d">07ab878</a>. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">

      <p>You may verify this by comparing the line</p>

      <pre class="cli"><code>## Committing: Site updated at 2016-02-22 03:37:22 UTC
</code></pre>

      <p>in the above error message in the “Problem” section with commit
<a href="https://github.com/VincentTam/vincenttam.github.io/commits/748fbd7">748fbd7</a> on GitHub.  Due to the growth of this site, each commit
on the <code>master</code> branch now involves over 400 files and thousands
of lines of insertion and deletion.  If I provide a direct link to
the commit, it will take too long to load the page.  Therefore, I
give the commit history at a particular node instead. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>
]]></content>
    
  </entry>
  
</feed>
